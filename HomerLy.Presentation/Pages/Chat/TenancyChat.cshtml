@page "/Chat/Tenancy/{tenancyId:guid}"
@model HomerLy.Presentation.Pages.Chat.TenancyChatModel
@{
    ViewData["Title"] = "Tenancy Chat";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Tenancy Chat
                    </h4>
                    <small>Real-time messaging for tenancy discussions</small>
                </div>

                @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                {
                    <div class="alert alert-danger m-3">
                        @Model.ErrorMessage
                    </div>
                }
                else if (Model.HasAccess)
                {
                    <div class="card-body p-0">
                        <!-- Chat Messages Area -->
                        <div id="chatMessages" class="chat-messages p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                            @foreach (var message in Model.Messages)
                            {
                                var isCurrentUser = message.SenderId.ToString() == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                                <div class="message-container mb-3 @(isCurrentUser ? "text-end" : "text-start")">
                                    <div class="message @(isCurrentUser ? "message-sent" : "message-received")" 
                                         style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 15px; @(isCurrentUser ? "background-color: #007bff; color: white;" : "background-color: white; border: 1px solid #dee2e6;")">
                                        <div class="message-header mb-1">
                                            <strong>@message.SenderName</strong>
                                            <span class="badge @(message.SenderRole == "Admin" ? "bg-danger" : message.SenderRole == "Owner" ? "bg-success" : "bg-info") ms-2">
                                                @message.SenderRole
                                            </span>
                                        </div>
                                        <div class="message-text">
                                            @message.Message
                                        </div>
                                        <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                                            @message.SentAt.ToLocalTime().ToString("MMM dd, yyyy HH:mm")
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Typing Indicator -->
                        <div id="typingIndicator" class="px-3 py-2" style="display: none; background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
                            <small class="text-muted">
                                <i class="bi bi-three-dots"></i> <span id="typingUserName"></span> is typing...
                            </small>
                        </div>

                        <!-- Message Input Area -->
                        <div class="card-footer bg-white">
                            <div class="input-group">
                                <input type="text" 
                                       id="messageInput" 
                                       class="form-control" 
                                       placeholder="Type your message here..." 
                                       maxlength="2000"
                                       aria-label="Message input">
                                <button class="btn btn-primary" type="button" id="sendButton">
                                    <i class="bi bi-send"></i> Send
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        const tenancyId = '@Model.TenancyId';
        const currentUserId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
        
        // Initialize SignalR connection
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        // Handle incoming messages
        connection.on("ReceiveMessage", function (message) {
            addMessageToChat(message);
            scrollToBottom();
        });

        // Handle chat history load
        connection.on("LoadChatHistory", function (messages) {
            messages.forEach(message => {
                addMessageToChat(message, true);
            });
            scrollToBottom();
        });

        // Handle typing indicator
        connection.on("UserTyping", function (data) {
            if (data.isTyping) {
                document.getElementById('typingUserName').textContent = data.userName;
                document.getElementById('typingIndicator').style.display = 'block';
            } else {
                document.getElementById('typingIndicator').style.display = 'none';
            }
        });

        // Handle errors
        connection.on("Error", function (message) {
            alert("Error: " + message);
        });

        // Start connection
        connection.start()
            .then(() => {
                console.log("Connected to chat hub");
                return connection.invoke("JoinTenancyChat", tenancyId);
            })
            .catch(err => console.error("Error connecting to chat:", err));

        // Send message
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Typing indicator
        let typingTimer;
        document.getElementById('messageInput').addEventListener('input', function () {
            clearTimeout(typingTimer);
            connection.invoke("TypingIndicator", tenancyId, true).catch(err => console.error(err));
            
            typingTimer = setTimeout(() => {
                connection.invoke("TypingIndicator", tenancyId, false).catch(err => console.error(err));
            }, 1000);
        });

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                connection.invoke("SendMessage", tenancyId, message)
                    .then(() => {
                        input.value = '';
                        connection.invoke("TypingIndicator", tenancyId, false);
                    })
                    .catch(err => console.error("Error sending message:", err));
            }
        }

        function addMessageToChat(message, isHistory = false) {
            const chatMessages = document.getElementById('chatMessages');
            const isCurrentUser = message.senderId === currentUserId;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-container mb-3 ${isCurrentUser ? 'text-end' : 'text-start'}`;
            
            const roleBadgeClass = message.senderRole === 'Admin' ? 'bg-danger' : 
                                   message.senderRole === 'Owner' ? 'bg-success' : 'bg-info';
            
            messageDiv.innerHTML = `
                <div class="message ${isCurrentUser ? 'message-sent' : 'message-received'}" 
                     style="display: inline-block; max-width: 70%; padding: 10px 15px; border-radius: 15px; ${isCurrentUser ? 'background-color: #007bff; color: white;' : 'background-color: white; border: 1px solid #dee2e6;'}">
                    <div class="message-header mb-1">
                        <strong>${message.senderName}</strong>
                        <span class="badge ${roleBadgeClass} ms-2">${message.senderRole}</span>
                    </div>
                    <div class="message-text">
                        ${message.message}
                    </div>
                    <div class="message-time mt-1" style="font-size: 0.75rem; opacity: 0.7;">
                        ${new Date(message.sentAt).toLocaleString()}
                    </div>
                </div>
            `;
            
            if (isHistory) {
                chatMessages.insertBefore(messageDiv, chatMessages.firstChild);
            } else {
                chatMessages.appendChild(messageDiv);
            }
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Disconnect when leaving page
        window.addEventListener('beforeunload', () => {
            connection.invoke("LeaveTenancyChat", tenancyId);
            connection.stop();
        });

        // Initial scroll to bottom
        scrollToBottom();
    </script>
}
